(function($,undefined){
  var wjteditorV = new Vue({
    el:'#wjtdfowie',
    data:{
      tmp:'',
    },
    computed:{
      wordCount:function(){
        if (undefined==this.text){
          return 0;
        }
        return this.text.length;
      }
    },
    methods:{
      toComment:function(event){
        commentV.toComment(event);
      }
    }
  });
  var commentVP = new Vue({
    el:'#wjtdfae',
    methods:{
      toComment:function(event){
        commentV.toComment(event);
      }
    }
  });
  var commentV = new Vue({
    el:'#wjtsdfweoisdh',
    data:{
      page:1,
      count:0,
      totlePage:0,
      list:[]
    },
    methods:{
      replyParent:function(event){
        $('.wjtdfweroiasndf').slideUp();
        $('.wjtdfwoieryy'+$(event.target).attr('data-index')).slideDown();
      },
      replyChildren:function(event){
        var $this = $(event.target);
        $('.wjtdfweroiasndf').slideUp();
        $('.wjtdkfjoaie'+$this.attr('data-id')).slideDown();
      },
      toComment:function(event){
        var $this = $(event.target);
        if ($($this.attr('data-inputid')).val().length<=300){
          wjtcomment('review',$this.attr('data-proid'),$this.attr('data-commid'),$($this.attr('data-inputid')).val(),function(){
              FP_OBJ.Q_LOGIN(function(){
                wjtcomment('review',$this.attr('data-proid'),$this.attr('data-commid'),$($this.attr('data-inputid')).val(),function(){  },function(){
                  alert('发表成功');
                  ThisPage.renderCommentList();
                },function(msg){alert(msg)});
              },function(msg){
                alert("登录失败："+msg);
              },function(){
              });},function(){
            alert('发表成功');
            ThisPage.renderCommentList();
          },function(msg){alert(msg)});
        } else {
          alert("字数超出了300");
        }
      },
      renderPaging:function() {
        var paginghtml = Paging.render({
            currentPage: this.page,
            pageCount: this.totlePage,
            link:''
        });
        $("#wjtafaeiu").empty();
        $("#wjtafaeiu").html(paginghtml);
      }
    }
  });
  var ThisPage={
    run:function(){
      ThisPage.render();
      ThisPage.bind();
    },
    bind:function(){
      $(".E-prolastCon a[href$='.jpg'],a[href$='.jpeg'],a[href$='.png'],a[href$='.gif']").attr('rel', 'gallery').fancybox({
        padding : 0,
        helpers:{
          wrap:{
            width: "50px",
            height: "auto"
          }
        }
      });
      $("#wjtafaeiu").on('click', 'a.ui-paging-item,a.ui-paging-next,a.ui-paging-prev', function () {
          $('.ui-paging-current').removeClass('ui-paging-current');
          $(this).addClass('ui-paging-current');
          var $this = $(this);
          commentV.page = $this.attr('href');
          ThisPage.renderCommentList();
          return false
      })
      .on('click', '.ui-paging-goto', function () {
          var $this = $(this)
          var $input = $this.prev('.ui-paging-which').find('input')
          var value = $input.val()
          // 必须填入数字
          value = parseInt(value, 10)
          if (isNaN(value)) {
              value = 1
          }
          if (value>pages){
            value=pages;
          }
          commentV.page=value;
          ThisPage.renderCommentList();
          $('html,body').animate({scrollTop: '170%'}, 1000);
          return false;
      });
    },
    render:function(){
      setTimeout(function(){
        ThisPage.renderCommentList();
      },0);
    },
    renderCommentList:function(){
      $.ajax({
        url: '/comment/review/<%=review.id%>',
        type: 'GET',
        dataType: 'json',
        cache:false,
      })
      .done(function(data) {
        if(data.status) {
          commentV.list = data.data.comments;
          commentV.page = data.data.paging.curPage;
          commentV.count=data.data.paging.totleRow;
          commentV.totlePage =data.data.paging.totlePage;
          commentV.renderPaging();
        }
      });

    }
  };
  ThisPage.run();
})(jQuery);
